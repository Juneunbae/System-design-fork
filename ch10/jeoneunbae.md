# 알림 시스템 설계

알림 시스템은 모바일 알림, SMS 메시지, 이메일로 분류할 수 있다.

## 1단계. 문제 이해 및 설계 범위 확정
- 연성 실시간(soft real-time) 시스템이라고 가정합니다. </br> 알림은 가능한 빨리 전달되어야 하지만 시스템에 높은 부하가 걸렸을 대 약간의 지연은 무방
- 클라이언트 애플리케이션 프로그램이 만들 수도 있고, 서버 측에서 스케줄링 할 수도 있다.
- 알림을 받지 않도록 설정할 수 있으며, 해당 설정을 마친 사용자는 더 이상 알림을 받지 않는다.
- 하루 천만 건의 모바일 푸시 알림, 백만 건의 SMS 메시지, 5백만 건의 이메일을 보낼 수 있어야 한다.

## 2단계. 개략적 설계안 제시 및 동의 구하기

### 알림 유형별 지원 방안

#### iOS 푸시 알림

<img width="1188" height="318" alt="image" src="https://github.com/user-attachments/assets/3072291b-d3f2-4193-9e02-e8af7ef28869" />

알림 제공자(Provider) : 알림 요청(notification request)을 만들어 애플 푸시 알림 서비스(APNS)로 보내는 주체

APNS : 애플이 제공하는 원격 서비스이며, 푸시 알림을 iOS 장치로 보내는 역할을 담당

iOS 단말(iOS device) : 푸시 알림을 수신하는 사용자 단말

#### 안드로이드 푸시 알림

<img width="1156" height="244" alt="image" src="https://github.com/user-attachments/assets/c928ef44-940c-4c36-a1f3-649df5811661" />


안드로이드 푸시 알림도 비슷한 절차로 전송되며, APNS 대신 FCM을 사용한다는 점만 다르다.

#### SMS 메시지

<img width="1144" height="265" alt="image" src="https://github.com/user-attachments/assets/c42d9f64-0bb6-4c8d-9da8-b5e7ecf987d9" />

SMS 메시지를 보낼 때는 보통 트윌리오, 넥스모 같은 제 3사업자의 서비스를 많이 이용한다.

이런 서비스는 대부분 상용 서비스라서 이용요금을 내야 한다.

#### 이메일

<img width="1198" height="312" alt="image" src="https://github.com/user-attachments/assets/3f1454b1-6d8e-42ea-9655-3f36c3856209" />

대부분의 회사는 고유 이메일 서버를 구축할 역량은 갖추고 있음에도 사용 이메일 서비스를 이용한다.

### 연락처 정보 수집 절차

<img width="1763" height="518" alt="image" src="https://github.com/user-attachments/assets/2fa9e065-9164-4f1c-a347-3669410aa6c0" />

알림을 보내려면 모바일 단말 토큰, 전화번호, 이메일 주소 등의 정보가 필요하다.

사용자가 우리 앱을 설치하거나 처음으로 계정을 등록하면 API 서버는 해당 사용자의 정보를 수집하여 DB에 저장한다.


|User 테이블|Column|Type|
|---|---|---|
||user_id|bigint|
||email|varchar|
||country_code|integer|
||phone_number|integer|
||created_at|timestamp|

|Device 테이블|Column|Type|
|---|---|---|
||id|bigint|
||device_token|varchar|
||user_id|bigint|
||last_logged_in_at|timestamp|

### 알림 전송 및 수신 절차

#### 개략적 설계안(초안)

1부터 N까지의 서비스
- 서비스 각각은 마이크로서비스일 수도 있고, 크론잡일 수도 있고, 분산 시스템 컴포넌트일 수도 있다.

알림 시스템
- 알림 시스템은 알림 전송/수신 처리의 핵심이다.
- 알림 전송을 위해 서비스 1 ~ N에 알림 전송을 위한 API를 제공해야 하고, 제3자 서비스에 전달할 알림 페이로드를 만들어 낼 수 있어야한다.

제3자 서비스
- 이 서비스들은 사용자에게 알림을 실제로 전달하는 역할을 한다.
- 쉽게 새로운 서비스를 통합하거나 기존 서비스를 제거할 수 있어야한다.

<img width="1401" height="645" alt="image" src="https://github.com/user-attachments/assets/809d8152-4e81-4a5f-9dcf-8442e6bbff2d" />

이 설계에는 몇 가지 문제가 있다.

SPOF(Single-Point-Of-Failure)
- 알림 서비스에 서버가 하나밖에 없다는 것은 그 서버에 장애가 생기면 전체 서비스의 장애로 이어진다는 뜻이다.

규모 확장성
- 한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로, 데이터베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다.

성능 병목
- 알림을 처리하고 보내는 것은 자원을 많이 필요로 하는 작업일 수 있다.
- 따라서 모든 것을 한 서버로 처리하면 사용자 트래픽이 많이 몰리는 시간에는 시스템이 과부화 상태에 빠질 수 있다.

#### 개략적 설계안 (개선된 버전)
초안의 문제점 파악 후 개선한다.

- 데이터베이스와 캐시를 알림 시스템의 주 서버에서 분리한다.
- 알림 서버를 증설하고 자동으로 수평적 규모 확장이 이루어질 수 있도록 한다.
- 메시지 큐를 이용해 시스템 컴포넌트 사이의 강한 결합을 끊는다.

<img width="1698" height="737" alt="image" src="https://github.com/user-attachments/assets/ecb5592d-2cdc-41a3-b1c9-d00374be0450" />

이 컴포넌트들이 어떻게 협력하여 알림을 전송하게 되는지 보자.

1. API 호출하여 알림 서버로 알림을 보낸다.
2. 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 메타데이터를 캐시나 데이터베이스에서 가져온다.
3. 알림 서버는 전송할 알림에 맞는 이벤트를 만들어서 해당 이벤트를 위한 큐를 넣는다. </br> 가령 iOS 푸시 알림 이벤트는 iOS 푸시 알림 큐에 넣어야 한다.
4. 작업 서버는 메시지 큐에서 알림 이벤트를 꺼낸다.
5. 작업 서버는 알림을 제3자 서비스로 보낸다.
6. 제3자 서비스는 사용자 단말로 알림을 전송한다.

## 3단계. 상세 설계

### 안정성
분산 환경에서 운영될 알림 시스템을 설계할 때는 안정성을 확보하기 위한 사항 몇 가지를 반드시 고려해야 한다.

#### 데이터 손실 방지
알림 전송 시스템의 가장 중요한 요구사항 가운데 하나는 어떤 상황에서도 알림이 소실되면 안 된다는 것이다. </br> 알림이 지연되거나 순서가 틀려도 괜찮지만, 사라지면 곤란하다. </br> 이 요구사항을 만족하려면 알림 시스템은 알림 데이터를 데이터베이스에 보관하고 재시도 메커니즘을 구현해야 한다.

#### 알림 중복 전송 방지

같은 알림이 여러 번 반복되는 것을 완전히 막는 것은 가능하지 않다. </br> 그 빈도를 줄이려면 중복을 탐지하는 메커니즘을 도입하고, 오류를 신중하게 처리해야 한다. </br> 간단 중복 방지 로직의 사례

- 보내야 할 알림이 도착하면 그 이벤트 ID를 검사하여 이전에 본 적이 있는 이벤트인지 살핀다.
- 중복된 이벤트라면 버리고, 그렇지 않으면 알림을 발송한다.

#### 알림 설정
많은 웹 사이트와 앱에서는 사용자가 알림 설정을 상세히 조정할 수 있도록 하고 있다.
이 정보는 알림 설정 테이블에 보관되며, 이 테이블에는 아마 다음과 같은 필드들이 필요할 것이다.

|Column|Type|
|---|---|
|user_id|bigint|
|channel|varchar|
|opt_in|boolean|

#### 재시도 방법
제3자 서비스가 알림 전송에 실패하면, 해당 알림을 재시도 전용 큐에 넣는다. </br>
같은 문제가 계속해서 발생하면 개발자에게 통지한다.
